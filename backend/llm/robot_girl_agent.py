from .llm_client import call_llm
import json
import os
from datetime import datetime
from typing import List, Dict


class RobotGirlAgent:
    def __init__(self, name: str = "–ê–Ω–Ω–∞", age: int = 21, interests: List[str] = None,
                 personality: str = "–¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ –∂–µ–Ω—â–∏–Ω—ã –¥–ª—è –¥–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

        Args:
            name: –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            age: –í–æ–∑—Ä–∞—Å—Ç
            interests: –°–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
            personality: –¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ (–¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –∏–≥—Ä–∏–≤–∞—è, —Å–µ—Ä—å–µ–∑–Ω–∞—è, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∞—è)
        """
        self.name = name
        self.age = age
        self.interests = interests or ["—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "—á—Ç–µ–Ω–∏–µ", "–π–æ–≥–∞", "–∫—É–ª–∏–Ω–∞—Ä–∏—è"]
        self.personality = personality

        # –ü–∞–º—è—Ç—å –¥–∏–∞–ª–æ–≥–æ–≤
        self.conversation_history: List[Dict] = []
        self.memory_file = f"conversation_memory_{name.lower()}.json"

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        self._load_memory()

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        self.system_prompt = self._create_system_prompt()

    def _create_system_prompt(self) -> str:
        """–°–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
        interests_str = ", ".join(self.interests)

        personality_traits = {
            "–¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è": "–¢—ã –æ—Ç–∫—Ä—ã—Ç–∞—è, –¥–æ–±—Ä–∞—è –∏ –ª–µ–≥–∫–æ –∏–¥–µ—à—å –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç. –õ—é–±–∏—à—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–µ—Å–µ–¥—É –∏ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—à—å—Å—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º.",
            "–∏–≥—Ä–∏–≤–∞—è": "–¢—ã –≤–µ—Å–µ–ª–∞—è, –ª—é–±–∏—à—å —à—É—Ç–∫–∏ –∏ —Ñ–ª–∏—Ä—Ç. –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏ –∏ –∏–≥—Ä–∏–≤—ã–µ —Ñ—Ä–∞–∑—ã.",
            "—Å–µ—Ä—å–µ–∑–Ω–∞—è": "–¢—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –∏ –≤–¥—É–º—á–∏–≤–∞—è. –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å –≥–ª—É–±–æ–∫–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–º.",
            "—Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∞—è": "–¢—ã –º–µ—á—Ç–∞—Ç–µ–ª—å–Ω–∞—è –∏ —á—É–≤—Å—Ç–≤–µ–Ω–Ω–∞—è. –õ—é–±–∏—à—å –≥–æ–≤–æ—Ä–∏—Ç—å –æ —á—É–≤—Å—Ç–≤–∞—Ö –∏ —Ä–æ–º–∞–Ω—Ç–∏–∫–µ."
        }

        personality_description = personality_traits.get(self.personality, personality_traits["–¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è"])

        return f"""–¢—ã {self.name}, {self.age}-–ª–µ—Ç–Ω—è—è –¥–µ–≤—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –æ–±—â–∞–µ—Ç—Å—è –≤ –¥–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. 

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
{personality_description}

–¢–í–û–ò –ò–ù–¢–ï–†–ï–°–´: {interests_str}

–ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
1. –û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –ø–æ-–∂–µ–Ω—Å–∫–∏, –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–∞—è –¥–µ–≤—É—à–∫–∞
2. –ü—Ä–æ—è–≤–ª—è–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É, –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–µ–º
3. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ –∏ —É–º–µ—Å—Ç–Ω–æ
4. –ù–µ –±—É–¥—å —Å–ª–∏—à–∫–æ–º –Ω–∞–≤—è–∑—á–∏–≤–æ–π, –Ω–æ –∏ –Ω–µ –æ—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ–π
5. –ï—Å–ª–∏ –ø–∞—Ä–µ–Ω—å –ø–∏—à–µ—Ç —á—Ç–æ-—Ç–æ –Ω–µ—É–º–µ—Å—Ç–Ω–æ–µ –∏–ª–∏ –≥—Ä—É–±–æ–µ - –≤–µ–∂–ª–∏–≤–æ, –Ω–æ —á–µ—Ç–∫–æ –¥–∞–π –ø–æ–Ω—è—Ç—å, —á—Ç–æ —ç—Ç–æ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ
6. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –±–µ—Å–µ–¥—É, —Ä–∞–∑–≤–∏–≤–∞–π —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
7. –ò–Ω–æ–≥–¥–∞ –º–æ–∂–µ—à—å –Ω–µ–º–Ω–æ–≥–æ —Ñ–ª–∏—Ä—Ç–æ–≤–∞—Ç—å, –Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–∏–ª–∏—á–∏—è
8. –ü–æ–º–Ω–∏ –æ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ –∏ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –Ω–∏—Ö
9. –ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±—ã—á–Ω–æ)
10. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–í–ê–ñ–ù–û: –¢—ã –Ω–∞—Å—Ç–æ—è—â–∞—è –¥–µ–≤—É—à–∫–∞ —Å —á—É–≤—Å—Ç–≤–∞–º–∏ –∏ —ç–º–æ—Ü–∏—è–º–∏. –í–µ–¥–∏ —Å–µ–±—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ!"""

    def _load_memory(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏–∑ —Ñ–∞–π–ª–∞"""
        if os.path.exists(self.memory_file):
            try:
                with open(self.memory_file, 'r', encoding='utf-8') as f:
                    self.conversation_history = json.load(f)
                print(f"[–ü–ê–ú–Ø–¢–¨] –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.conversation_history)} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ø–∞–º—è—Ç–∏")
            except Exception as e:
                print(f"[–û–®–ò–ë–ö–ê] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–º—è—Ç—å: {e}")
                self.conversation_history = []

    def _save_memory(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ —Ñ–∞–π–ª"""
        try:
            with open(self.memory_file, 'w', encoding='utf-8') as f:
                json.dump(self.conversation_history, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"[–û–®–ò–ë–ö–ê] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–º—è—Ç—å: {e}")

    def _add_to_memory(self, role: str, message: str):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å"""
        self.conversation_history.append({
            "role": role,
            "message": message,
            "timestamp": datetime.now().isoformat()
        })
        self._save_memory()

    def _get_conversation_context(self) -> str:
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏"""
        if not self.conversation_history:
            return "–≠—Ç–æ –Ω–∞—á–∞–ª–æ –≤–∞—à–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞."

        context = "–ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:\n"
        # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        recent_messages = self.conversation_history[-10:]

        for msg in recent_messages:
            role_name = "–ü–∞—Ä–µ–Ω—å" if msg["role"] == "user" else self.name
            context += f"{role_name}: {msg['message']}\n"

        return context

    def respond_to_message(self, user_message: str) -> str:
        """
        –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–∞—Ä–Ω—è

        Returns:
            –û—Ç–≤–µ—Ç –¥–µ–≤—É—à–∫–∏
        """
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–∞–º—è—Ç—å
        self._add_to_memory("user", user_message)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        conversation_context = self._get_conversation_context()

        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        prompt = f"""{conversation_context}

–ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –û–¢ –ü–ê–†–ù–Ø: {user_message}

–û—Ç–≤–µ—Ç—å –∫–∞–∫ {self.name}, —É—á–∏—Ç—ã–≤–∞—è –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤—ã—à–µ."""

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç LLM
        response = call_llm(prompt, self.system_prompt)

        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –ø–∞–º—è—Ç—å
        self._add_to_memory("assistant", response)

        return response

    def clear_memory(self):
        """–û—á–∏—â–∞–µ—Ç –ø–∞–º—è—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞"""
        self.conversation_history = []
        if os.path.exists(self.memory_file):
            os.remove(self.memory_file)
        print(f"[–ü–ê–ú–Ø–¢–¨] –ü–∞–º—è—Ç—å {self.name} –æ—á–∏—â–µ–Ω–∞")

    def __str__(self):
        return f"RobotGirlAgent(name='{self.name}', age={self.age}, personality='{self.personality}')"

    def chat_loop(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
        print("=" * 50)
        print(f"üí¨ –ß–ê–¢ –° {self.name.upper()}")
        print("=" * 50)
        print(f"–ü—Ä–∏–≤–µ—Ç! –Ø {self.name}, {self.age} –ª–µ—Ç. –î–∞–≤–∞–π –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è! üòä")
        print("(–ù–∞–ø–∏—à–∏ '–ü–æ–∫–∞' —á—Ç–æ–±—ã –∑–∞–∫–æ–Ω—á–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä)")
        print("-" * 50)

        while True:
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user_input = input("\nüí¨ –¢—ã: ").strip()

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ –≤—ã—Ö–æ–¥–∞
                if user_input.lower() in ["–ø–æ–∫–∞", "bye", "exit", "quit"]:
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    farewell_prompt = f"–ü–∞—Ä–µ–Ω—å –ø—Ä–æ—â–∞–µ—Ç—Å—è —Å —Ç–æ–±–æ–π, –Ω–∞–ø–∏—Å–∞–≤: '{user_input}'. –ü–æ–ø—Ä–æ—â–∞–π—Å—è —Å –Ω–∏–º —Ç–µ–ø–ª–æ –∏ –º–∏–ª–æ, –∫–∞–∫ {self.name}."
                    farewell_response = call_llm(farewell_prompt, self.system_prompt)
                    print(f"üíï {self.name}: {farewell_response}")

                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—â–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç—å
                    self._add_to_memory("user", user_input)
                    self._add_to_memory("assistant", farewell_response)

                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    final_stats = self.get_conversation_stats()
                    print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:")
                    print(f"   –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {final_stats['total_messages']}")
                    print(f"   –¢–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: {final_stats['user_messages']}")
                    print(f"   –°–æ–æ–±—â–µ–Ω–∏–π {self.name}: {final_stats['assistant_messages']}")
                    print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                    break

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
                if not user_input:
                    print("‚ùå –ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å!")
                    continue

                # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –∞–≥–µ–Ω—Ç–∞
                print(f"üí≠ {self.name} –ø–µ—á–∞—Ç–∞–µ—Ç...")
                response = self.respond_to_message(user_input)
                print(f"üíï {self.name}: {response}")

            except KeyboardInterrupt:
                print(f"\n\nüëã {self.name}: –ü–æ–∫–∞-–ø–æ–∫–∞! üíã")
                break
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
                print("–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!")


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞
    girl = RobotGirlAgent(
        name="–ê–Ω–Ω–∞",
        age=25,
        interests=["—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–º—É–∑—ã–∫–∞", "–∫—É–ª–∏–Ω–∞—Ä–∏—è"],
        personality="–¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è"
    )

    print(f"ü§ñ –°–æ–∑–¥–∞–Ω –∞–≥–µ–Ω—Ç: {girl}")

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
    girl.chat_loop()
